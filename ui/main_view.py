import os
import threading
import time
import flet as ft
import logging
from pathlib import Path
from modules.video_processor import start_processing, stop_processing, get_thumbnail_by_video_path
from modules.search_manager import (
    search_in_index,
    smart_search,
    very_smart_filter,
    get_current_index,
    start_search_monitoring,
    enable_smart_search,
    smart_keyword_search,
)
from modules.enhanced_neural_processor import start_enhanced_neural_processing, stop_enhanced_neural_processing
from ui.image_view import create_image_view
from modules.settings_manager import load_settings
from modules.update_core import get_current_version, load_update_manifest, compare_versions

logger = logging.getLogger(__name__)



def create_main_view(page, on_settings=None, on_favorites=None):
    page.snack_bar = ft.SnackBar(content=ft.Text(""))

    thumbs_dir = Path("thumbnails")
    thumbs_dir.mkdir(exist_ok=True)
    last_loaded_count = -1

    has_selected_files = False
    selected_files = []
    selected_directory = None

    current_view = "thumbnails"
    current_query = ""
    current_page = 0
    filtered_results = []
    page_thumbnails = []

    model_loader = ft.ProgressRing(width=24, height=24, visible=False)
   #def update_if_changed(query_str):
   #    nonlocal current_query
   #    # –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
   #    if query_str == current_query:
   #        return
   #    current_query = query_str
   #    update_search_results(perform_search(query_str))
   #
    def perform_search(query):
        query = query.strip()
        if not query:
            return list(get_current_index().keys())

        settings = load_settings()
        use_smart = settings.get("smart_search_enabled", False)
        use_very  = settings.get("very_smart_enabled", False)

        if use_very:
            candidates = smart_search(query, force=True)
            logger.info(f"–ö–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –æ—Ç smart_search: {len(candidates)}")
            return very_smart_filter(candidates, query)

        if use_smart:
            return smart_search(query, force=True)

        return smart_keyword_search(query)
    def update_search_results(results):
        nonlocal filtered_results
        filtered_results = results
        load_thumbnails_from_results()




    def check_and_show_update_popup(page):
        from modules.update_core import (
            get_current_version,
            load_update_manifest,
            compare_versions,
            get_update_description,
            get_files_to_update,
        )
        from modules.updater import perform_update
        import threading
        from ui.update_popup import open_popup, close_popup
    
        print("üîç settings_view.check_and_show_update_popup –≤—ã–∑–≤–∞–Ω")
    
        manifest = load_update_manifest()
        if not manifest:
            open_popup(page, "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.", on_yes=None)
            return
    
        if compare_versions(get_current_version(), manifest["version"]):
            description = get_update_description(manifest)
            message = (
                f"–î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è {manifest['version']}.\n\n"
                f"{description}\n\n"
                "–û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å?"
            )
    
            def on_yes(e):
                # –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –¥–∏–∞–ª–æ–≥
                close_popup(page)
    
                def do_update():
                    # –°–∫–∞—á–∏–≤–∞–µ–º –∏ –Ω–∞–∫–∞—Ç—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                    files = get_files_to_update(manifest)
                    perform_update(files)
                    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –¥–∏–∞–ª–æ–≥ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
                    open_popup(
                        page,
                        "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É.",
                        on_yes=None
                    )
    
                # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤ —Ñ–æ–Ω–æ–≤–æ–º –ø–æ—Ç–æ–∫–µ, —á—Ç–æ–±—ã UI –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª—Å—è
                threading.Thread(target=do_update, daemon=True).start()
    
            open_popup(page, message, on_yes)
        else:
            open_popup(page, "–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è.", on_yes=None)

    
    def load_model_async():
        settings = load_settings()
        if settings.get("smart_search_enabled", False):
            model_loader.visible = True
            set_status("üß† –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –º–æ–¥–µ–ª—å —É–º–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞...", loading=True)
            page.update()
    
            enable_smart_search()
    
            model_loader.visible = False
            set_status("‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞", loading=False)
            page.update()




    def on_select_files(e):
        """–í—ã–±–∏—Ä–∞–µ—Ç –≤–∏–¥–µ–æ—Ñ–∞–π–ª—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏"""
        nonlocal has_selected_files, selected_files
        set_status(f"üìÑ –í—ã–±—Ä–∞–Ω–æ {len(selected_files)} —Ñ–∞–π–ª–æ–≤", loading=False)
       
        def pick_files_result(e: ft.FilePickerResultEvent):
            nonlocal has_selected_files, selected_files
            
            if e.files:
                selected_files = [file.path for file in e.files]
                video_files_text.value = f"–í—ã–±—Ä–∞–Ω–æ {len(selected_files)} —Ñ–∞–π–ª–æ–≤"
                has_selected_files = True
                page.update()
        
        pick_files_dialog = ft.FilePicker(on_result=pick_files_result)
        page.overlay.append(pick_files_dialog)
        page.update()
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
        pick_files_dialog.pick_files(
            allow_multiple=True,
            allowed_extensions=["mp4", "avi", "mov", "mkv", "mxf", "webm"]
        )

    def on_select_directory(e):
        """–í—ã–±–∏—Ä–∞–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏"""
        nonlocal has_selected_files, selected_directory
        
        def pick_directory_result(e: ft.FilePickerResultEvent):
            nonlocal has_selected_files, selected_directory
            
            if e.path:
                selected_directory = e.path
                video_files_text.value = f"–í—ã–±—Ä–∞–Ω–∞ –ø–∞–ø–∫–∞: {os.path.basename(selected_directory)}"
                has_selected_files = True
                set_status(f"ÔøΩÔøΩ –í—ã–±—Ä–∞–Ω–∞ –ø–∞–ø–∫–∞: {os.path.basename(selected_directory)}", loading=False)
                page.update()
        
        pick_directory_dialog = ft.FilePicker(on_result=pick_directory_result)
        page.overlay.append(pick_directory_dialog)
        page.update()
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        pick_directory_dialog.get_directory_path()

    def maybe_add_update_icon():
        manifest = load_update_manifest()
        if manifest and compare_versions(get_current_version(), manifest["version"]):
            update_icon.visible = True
            page.update()
    
    update_icon = ft.IconButton(
        icon=ft.icons.SYSTEM_UPDATE,
        tooltip="–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ!",
        visible=False,
        on_click=lambda e: check_and_show_update_popup(page)
    )

# –≤ appbar.append(update_icon) ‚Äî –∏ –ø–æ—Ç–æ–º –≤—ã–∑–≤–∞—Ç—å maybe_add_update_icon()
    def on_start_processing(e):
        nonlocal has_selected_files, selected_directory, selected_files
    
        if not has_selected_files:
            set_status("‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã", loading=False)
            return
    
        if selected_directory:
            set_status(f"üìÇ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ –∏–∑ –ø–∞–ø–∫–∏: {os.path.basename(selected_directory)}...", loading=True)
        elif selected_files:
            if len(selected_files) == 1:
                set_status(f"üéûÔ∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ: {os.path.basename(selected_files[0])}...", loading=True)
            else:
                set_status(f"üéûÔ∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ {len(selected_files)} –≤–∏–¥–µ–æ—Ñ–∞–π–ª–æ–≤...", loading=True)
        else:
            set_status("‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ñ–∞–π–ª—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏", loading=False)
            return
    
        def on_processing_complete():
            set_status("‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞", loading=False)
            perform_search(current_query)  # –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            settings = load_settings()
            if settings.get("parallel_enabled", False):
                from modules.enhanced_neural_processor import start_enhanced_neural_processing
                start_enhanced_neural_processing()
                set_status("üß† –ó–∞–ø—É—â–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–µ–π—Ä–æ–æ–±—Ä–∞–±–æ—Ç–∫–∞", loading=True)
            page.update()
    
        if selected_directory:
            start_processing(folder_path=selected_directory, on_update=on_processing_complete)
        elif selected_files:
            start_processing(file_paths=selected_files, on_update=on_processing_complete)
    
    

        def on_processing_complete():
            set_status("‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞", loading=False)
            perform_search(current_query)  # –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            settings = load_settings()
        
            if settings.get("parallel_enabled", False):
                from modules.enhanced_neural_processor import (
                    start_enhanced_neural_processing,
                    get_enhanced_neural_processor
                )
                start_enhanced_neural_processing()
        
                # –ü–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –∑–∞–¥–∞—ë–º –∫–æ–ª–ª–±—ç–∫ –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
                processor = get_enhanced_neural_processor()
        
                # –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–∂–¥–æ–≥–æ –∫–∞–¥—Ä–∞
                def on_neural_done(path, result):
                    # –ï—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞ ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
                    if not processor.queued_files:
                        set_status("‚úÖ –ù–µ–π—Ä–æ–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞", loading=False)
        
                processor.on_file_processed = on_neural_done
        
            page.update()

    

    def on_stop_processing(e):
        stop_processing()
        set_status("üõë –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞", loading=False)
        stop_enhanced_neural_processing()
        page.update()

    
    
    def load_thumbnails_from_results():
        nonlocal current_page, filtered_results, page_thumbnails
        items_per_page = 25
        total_thumbnails = len(filtered_results)
        total_pages = (total_thumbnails + items_per_page - 1) // items_per_page
    
        if current_page >= total_pages and total_pages > 0:
            current_page = total_pages - 1
        elif current_page < 0:
            current_page = 0
    
        prev_button.disabled = current_page <= 0
        next_button.disabled = (current_page >= total_pages - 1 or total_pages <= 1)
        page_text.value = f"–°—Ç—Ä–∞–Ω–∏—Ü–∞ {current_page + 1} –∏–∑ {max(total_pages, 1)}"
    
        start_idx = current_page * items_per_page
        end_idx = min(start_idx + items_per_page, total_thumbnails)
        page_thumbnails = filtered_results[start_idx:end_idx]
    
        thumbnails_grid.controls.clear()
    
        if not page_thumbnails:
            thumbnails_grid.controls.append(
                ft.Container(
                    content=ft.Column([
                        ft.Icon(ft.icons.IMAGE_NOT_SUPPORTED, size=50),
                        ft.Text("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π", style="bodyMedium"),
                        ft.Text("–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã", style="bodySmall"),
                    ], horizontal_alignment=ft.CrossAxisAlignment.CENTER, spacing=10),
                    alignment=ft.alignment.center,
                    expand=True,
                )
            )
        else:
            for path in page_thumbnails:
                thumbnails_grid.controls.append(
                    ft.Container(
                        width=150,
                        height=150,
                        bgcolor=ft.colors.with_opacity(0.04, ft.colors.ON_BACKGROUND),
                        border_radius=ft.border_radius.all(10)
                    )
                )
    
        page.update()
    
        def update_images():
            for i, path in enumerate(page_thumbnails):
                full_path = os.path.join("thumbnails", path)
                image = ft.Image(
                    src=full_path,
                    width=150,
                    height=150,
                    fit=ft.ImageFit.COVER,
                    border_radius=ft.border_radius.all(10)
                )
                container = ft.Container(
                    content=image,
                    width=150,
                    height=150,
                    border_radius=ft.border_radius.all(10),
                    ink=True,
                    on_click=lambda e, p=path, img_list=page_thumbnails: on_image_click(
                        os.path.join("thumbnails", p),
                        [os.path.join("thumbnails", i) for i in img_list]
                    ),
                )
                thumbnails_grid.controls[i] = container
                page.update()
    
        threading.Thread(target=update_images, daemon=True).start()
    
    
    def load_thumbnails_from_results_page(page_num):
        nonlocal current_page
        current_page = page_num
        load_thumbnails_from_results()
    
    





    
    def perform_search(query):
        query = query.strip()
        if not query:
            return list(get_current_index().keys())
    
        settings = load_settings()
        use_smart = settings.get("smart_search_enabled", False)
        use_very  = settings.get("very_smart_enabled", False)
    
        # 1) ¬´–°—É–ø–µ—Ä‚Äë—É–º–Ω—ã–π¬ª = —Å–Ω–∞—á–∞–ª–∞ semantic‚Äësearch, –ø–æ—Ç–æ–º Pixtral‚Äëfilter

        if use_very:
            candidates = smart_search(query, force=True)
            logger.info(f"–ö–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –æ—Ç smart_search: {len(candidates)}")
            return very_smart_filter(candidates, query)

    
        # 2) –¢–æ–ª—å–∫–æ semantic
        if use_smart:
            return smart_search(query, force=True)
    
        # 3) –û–±—ã—á–Ω—ã–π keyword‚Äësearch
        return smart_keyword_search(query)
    
    
    

    # –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    video_files_text = ft.Text("–í—ã–±—Ä–∞–Ω–æ 0 —Ñ–∞–π–ª–æ–≤", size=14, color=ft.colors.ON_SURFACE_VARIANT)
    processing_status = ft.Text("–ì–æ—Ç–æ–≤ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ", size=14, color=ft.colors.ON_SURFACE_VARIANT)


    settings = load_settings()

    status_text = ft.Text("–ì–æ—Ç–æ–≤ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ", size=14, color=ft.colors.ON_SURFACE_VARIANT)
    status_spinner = ft.ProgressRing(width=16, height=16, visible=False)
    # –°–æ–∑–¥–∞–µ–º –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞

    search_field = ft.TextField(
        label="–ü–æ–∏—Å–∫",
        hint_text="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞",
        prefix_icon=ft.icons.SEARCH,
        expand=True,
    )
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ on_submit ‚Äì –∑–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter


    search_field.on_submit = lambda e: (
        set_status("üîç –ü–æ–∏—Å–∫...", loading=True),
        update_search_results(perform_search(e.control.value)),
        set_status("‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã", loading=False)
    )



    # –¥–æ–±–∞–≤–∏–º on_change, —á—Ç–æ–±—ã –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Å—Ä–∞–∑—É –≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ –±–µ–∑ Enter
    def on_search_change(e):
        # –µ—Å–ª–∏ –ø–æ–ª–µ –æ–ø—É—Å—Ç–µ–ª–æ ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∏—Å–∫
        if not e.control.value.strip():
            update_search_results(perform_search(""))
    
    search_field.on_change = on_search_change
    




    #search_field.on_submit = lambda e: update_search_results(perform_search(e.control.value))

        
    

    # –°–µ—Ç–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è 12 –º–∏–Ω–∏–∞—Ç—é—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, 4 —Å—Ç–æ–ª–±—Ü–∞, 3 —Ä—è–¥–∞)
    thumbnails_grid = ft.GridView(
        expand=True,
        runs_count=4,
        max_extent=200,
        child_aspect_ratio=1.0,
        spacing=10,
        run_spacing=10,
        padding=20,
    )

    # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç
    image_view_container = ft.Container(expand=True, visible=False)

    # –ü–∞–Ω–µ–ª—å –ø–∞–≥–∏–Ω–∞—Ü–∏–∏



    prev_button = ft.IconButton(
        icon=ft.icons.ARROW_BACK,
        tooltip="–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞",
        disabled=True,
        on_click=lambda e: load_thumbnails_from_results_page(current_page - 1),
    )
    
    next_button = ft.IconButton(
        icon=ft.icons.ARROW_FORWARD,
        tooltip="–°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞",
        disabled=True,
        on_click=lambda e: load_thumbnails_from_results_page(current_page + 1),
    )
    

    page_text = ft.Text("–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1", size=14)

    pagination = ft.Row(
        controls=[prev_button, page_text, next_button],
        alignment=ft.MainAxisAlignment.CENTER,
    )

    # –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

    toolbar = ft.Row([
        ft.IconButton(icon=ft.icons.INSERT_DRIVE_FILE, tooltip="–í—ã–±—Ä–∞—Ç—å –≤–∏–¥–µ–æ", on_click=on_select_files),
        ft.IconButton(icon=ft.icons.FOLDER_OPEN, tooltip="–í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É", on_click=on_select_directory),
        ft.IconButton(icon=ft.icons.PLAY_ARROW, tooltip="–û–±—Ä–∞–±–æ—Ç–∞—Ç—å", on_click=on_start_processing),
        ft.IconButton(icon=ft.icons.STOP, tooltip="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å", on_click=on_stop_processing),
        ft.Container(width=20),
        search_field,
        model_loader,  # <-- –¥–æ–±–∞–≤–∏–ª–∏ —Å—é–¥–∞
    ], alignment=ft.MainAxisAlignment.START)



    # –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    status_spinner = ft.ProgressRing(width=16, height=16, visible=False)
    
    # –¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞
    status_text = ft.Text("–ì–æ—Ç–æ–≤ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ", size=14, color=ft.colors.ON_SURFACE_VARIANT)
    
    status_bar = ft.Row([
        status_text,
        ft.Container(width=10),
        status_spinner,
    ], alignment=ft.MainAxisAlignment.START)

    # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ –≤—Å–µ–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏
    view = ft.Container(
        content=ft.Column([
            toolbar,
            ft.Divider(height=1),
            ft.Stack([thumbnails_grid, image_view_container], expand=True),
            ft.Divider(height=1),
            pagination,
            status_bar,
        ], spacing=10, expand=True),
        padding=10,
        expand=True,
    )

    # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    loading_container = ft.Container(
        content=ft.Column([
            ft.ProgressRing(width=40, height=40),
            ft.Text("–ó–∞–≥—Ä—É–∑–∫–∞...", style="bodyMedium"),
        ], horizontal_alignment=ft.CrossAxisAlignment.CENTER, spacing=10),
        alignment=ft.alignment.center,
        expand=True,
        bgcolor=ft.colors.with_opacity(0.7, ft.colors.BLACK),
        visible=False,
    )

    container_with_loading = ft.Stack(
        controls=[view, loading_container],
        expand=True,
    )

    # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É –º–∏–Ω–∏–∞—Ç—é—Ä


    def set_status(message: str, loading: bool = False):
        status_text.value = message
        status_spinner.visible = loading
        page.update()


    def show_thumbnails():
        image_view_container.visible = False
        thumbnails_grid.visible = True
        load_thumbnails_from_results()  # –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç—É –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É
        page.update()


    # –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –º–∏–Ω–∏–∞—Ç—é—Ä–µ. –¢–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–≤–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞:
    # image_path –∏ —Å–ø–∏—Å–æ–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
    def on_image_click(image_path, image_list):
        image_view = create_image_view(
            page,
            current_file=image_path,
            all_files=image_list,
            return_page=0,
            search_query=current_query,
            page_number=current_page,
            on_back=show_thumbnails
        )
        thumbnails_grid.visible = False
        image_view_container.visible = True
        image_view_container.content = image_view
        page.update()


    
    def update_images():
        for i, path in enumerate(page_thumbnails):
            full_path = os.path.join("thumbnails", path)
            image = ft.Image(
                src=full_path,
                width=150,
                height=150,
                fit=ft.ImageFit.COVER,
                border_radius=ft.border_radius.all(10)
            )
            container = ft.Container(
                content=image,
                width=150,
                height=150,
                border_radius=ft.border_radius.all(10),
                ink=True,
                on_click=lambda e, p=path, img_list=page_thumbnails: on_image_click(
                    os.path.join("thumbnails", p),
                    [os.path.join("thumbnails", i) for i in img_list]
                ),
            )
            thumbnails_grid.controls[i] = container
            page.update()
    
    #threading.Thread(target=update_images, daemon=True).start()
    

    # –ü–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–∏–Ω–∏–∞—Ç—é—Ä (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ)
    threading.Thread(target=lambda: update_search_results(perform_search("")), daemon=True).start()


    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ AppBar
    def on_favorites_click(e):
        if on_favorites:
            on_favorites()
            
    def on_settings_click(e):
        if on_settings:
            on_settings()
    def on_theme_toggle(e):
        settings = load_settings()
        settings["theme"] = "light" if e.control.value else "dark"
        from modules.settings_manager import save_settings
        save_settings(settings)
        page.theme_mode = settings["theme"]
        page.update()
    
    theme_switch = ft.Switch(
        value=load_settings().get("theme", "dark") == "light",
        on_change=on_theme_toggle
    )    
    # –°–æ–∑–¥–∞–µ–º AppBar –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
    if not page.appbar:

        page.appbar = ft.AppBar(
            title=ft.Text("Video Processor"),
            center_title=False,
            bgcolor=ft.colors.SURFACE_VARIANT,
            actions=[
                ft.Row(
                    controls=[
                        ft.Icon(name=ft.icons.DARK_MODE),
                        theme_switch,
                        ft.Icon(name=ft.icons.LIGHT_MODE),
                    ],
                    spacing=5,
                ),                                  
                update_icon,  # –≤–æ—Ç —Å—é–¥–∞ –¥–æ–±–∞–≤—å!
                ft.IconButton(
                    icon=ft.icons.FAVORITE,
                    tooltip="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ",
                    on_click=on_favorites_click,
                ),
                ft.IconButton(
                    icon=ft.icons.SETTINGS,
                    tooltip="–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
                    on_click=on_settings_click,
                ),
            ],
        )
        
        page.update()    
    threading.Thread(target=start_search_monitoring, daemon=True).start()



    def start_thumbnail_auto_refresh():
        def refresh_loop():
            nonlocal last_loaded_count
            while True:
                current_index = get_current_index()
                count = len(current_index)
    
                if count != last_loaded_count:
                    last_loaded_count = count
    
                    # –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç—ã –≤ –≥–ª–∞–≤–Ω–æ–º –æ–∫–Ω–µ –∏ –ù–ï –≤ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–µ
                    if current_view == "main" and not image_view_container.visible:
                        print("üîÅ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ —Å—Ç–æ–ø–∫–∞–¥—Ä—ã ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å")
                        update_search_results(perform_search(current_query))
    
                time.sleep(5)  # –º–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å –¥–æ 3 –¥–ª—è –±–æ–ª—å—à–µ–π "–∂–∏–≤–æ—Å—Ç–∏"
    
        threading.Thread(target=refresh_loop, daemon=True).start()
    

    
    
    start_thumbnail_auto_refresh()
    
    maybe_add_update_icon()

    return container_with_loading
